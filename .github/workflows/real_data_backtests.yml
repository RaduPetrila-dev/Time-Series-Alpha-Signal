name: Real Data Backtests

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-backtests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install -e ".[dev,arima]"

      - name: Run EWMA backtest
        run: |
          set -e
          python -m time_series_alpha_signal.cli run \
            --tickers AAPL,AMZN,GOOGL,META,NFLX \
            --start-date 2018-01-01 --end-date 2023-12-31 \
            --signal ewma_momentum --ewma-span 30 \
            --max-gross 1.0 --cost-bps 10 \
            --rebalance daily --impact-model proportional \
            --output results/faang_ewma_2018_2023

      - name: Run momentum backtest
        run: |
          set -e
          python -m time_series_alpha_signal.cli run \
            --tickers AAPL,AMZN,GOOGL,META,NFLX \
            --start-date 2018-01-01 --end-date 2023-12-31 \
            --signal momentum --lookback 20 \
            --max-gross 1.0 --cost-bps 10 \
            --rebalance weekly --impact-model sqrt \
            --output results/faang_momentum_2018_2023

      - name: Summarise metrics
        shell: bash
        run: |
          python - <<'PY'
          import json, pathlib
          root = pathlib.Path("results")
          lines = []
          for m in sorted(root.rglob("metrics.json")):
              d = json.loads(m.read_text())
              lines.append(
                  f"{m.parent.name}: "
                  f"Sharpe={d.get('sharpe', float('nan')):.2f}, "
                  f"CAGR={d.get('cagr', float('nan')):.4f}, "
                  f"MaxDD={d.get('max_dd', float('nan')):.2%}"
              )
          print("\n".join(lines))
          PY

      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          if [ -d results ]; then
            git add results
            git commit -m "Update FAANG backtests [skip ci]" || echo "No changes"
            git push || true
          else
            echo "No results directory found; skipping commit."
          fi
